<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>データ統合・再判定ツール</title>
</head>
<body>
    <h2>Firestore データ統合 (new_events 作成)</h2>
    <p>raw_events と event_labels を統合し、新ロジックで再ラベリングして new_events へ保存します。</p>
    <button id="runBtn">再構築実行</button>
    <div id="log" style="white-space: pre-wrap; margin-top: 10px; font-family: monospace; border: 1px solid #ccc; padding: 10px;"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 新しいオートラベリング・ロジック
function classifyNew(f) {
  const d = f.diffMax || 0;
  const zr = f.zRatio || 0;
  const zc = f.zConsistency; // 坂道判定用
  const xy = f.xyRatio || 0;

  if (zc === true) return "hill"; // 符号が一致してたら坂道
  if (d >= 45 && zr >= 0.55 && xy < 0.45) return "step"; // 分析結果の最強閾値
  if (xy > 0.6 && d < 35) return "curve";
  return "flat";
}

document.getElementById("runBtn").onclick = async () => {
  const log = document.getElementById("log");
  log.textContent = "処理開始...\n";

  try {
    // 1. データの読み込み
    log.textContent += "1. データ読み込み中...\n";
    const [rawSnap, labelSnap] = await Promise.all([
      getDocs(collection(db, "raw_events")),
      getDocs(collection(db, "event_labels"))
    ]);

    // 2. 正解(Ground Truth)のマップを作成
    const gtMap = {};
    labelSnap.forEach(doc => {
      const data = doc.data();
      gtMap[data.eventId] = data.groundTruth;
    });
    log.textContent += `   -> 正解ラベル ${labelSnap.size} 件取得\n`;

    // 3. new_events コレクションへ書き込み
    let count = 0;
    for (const rawDoc of rawSnap.docs) {
      const rawData = rawDoc.data();
      const eventId = rawDoc.id;

      // 新ロジックで再判定
      const newAutoLabel = classifyNew(rawData.features);
      // 正解ラベルを取得（なければ unknown）
      const groundTruth = gtMap[eventId] || "unknown";

      // 新しいドキュメント作成
      const newDoc = {
        ...rawData,           // 元のデータ（samples, features, lat, lng 等）をコピー
        new_autoLabel: newAutoLabel,
        groundTruth: groundTruth,
        processedAt: new Date().toISOString()
      };

      await addDoc(collection(db, "new_events"), newDoc);
      count++;
      if (count % 10 === 0) log.textContent += `   ... ${count} 件処理完了\n`;
    }

    log.textContent += `\n完了！ 合計 ${count} 件を 'new_events' に保存しました。`;
    alert("完了しました！");

  } catch (e) {
    log.textContent += `\nエラー発生: ${e.message}`;
    console.error(e);
  }
};
</script>
</body>
</html>