<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Barrier Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <style>
    body, html { margin: 0; height: 100%; }
    #map { height: 100%; }

    .panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .panel button {
      margin: 2px;
      padding: 4px 8px;
    }

    .legend {
      margin-top: 6px;
      font-size: 12px;
    }

    .box {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 4px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <b>表示モード</b><br>
  <button onclick="setMode('latest')">最新</button>
  <button onclick="setMode('all')">全データ</button>
  <button onclick="setMode('step')">段差のみ</button>
  <button onclick="setMode('both')">段差＋カーブ</button>

  <hr>

  <b>段差信頼度</b><br>
  <button onclick="setLevel(20)">6割</button>
  <button onclick="setLevel(25)">7割</button>
  <button onclick="setLevel(30)">8割</button>

  <div class="legend">
    <div><span class="box" style="background:#ffcccc"></span>6割</div>
    <div><span class="box" style="background:red"></span>7割</div>
    <div><span class="box" style="background:darkred"></span>8割</div>
    <div><span class="box" style="background:blue"></span>カーブ</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

const map = L.map("map").setView([35.68, 139.76], 15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let allData = [];
let markers = [];
let mode = "latest";
let level = 20;

/* データ取得 */
const snap = await getDocs(collection(db, "logs"));
snap.forEach(d => allData.push(d.data()));

function getColor(d) {
  if (d.type === "curve") return "blue";
  if (d.diff >= 30) return "darkred";
  if (d.diff >= 25) return "red";
  return "#ffcccc";
}

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function draw() {
  clearMarkers();

  let data = [...allData];

  if (mode === "latest") {
    data = [data[data.length - 1]];
  }

  if (mode === "step") {
    data = data.filter(d => d.type === "step");
  }

  if (mode === "both") {
    data = data.filter(d => d.type);
  }

  data = data.filter(d => {
    if (d.type === "step") return d.diff >= level;
    return true;
  });

  data.forEach(d => {
    const marker = L.circleMarker([d.lat, d.lng], {
      radius: 7,
      color: getColor(d),
      fillOpacity: 0.7
    }).addTo(map);

    marker.bindPopup(`
      <b>${d.type}</b><br>
      diff: ${d.diff.toFixed(1)}
    `);

    markers.push(marker);
  });
}

window.setMode = m => {
  mode = m;
  draw();
};

window.setLevel = l => {
  level = l;
  draw();
};

draw();
</script>
</body>
</html>
