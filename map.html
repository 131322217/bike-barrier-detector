<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Barrier Map - Evaluation</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
html, body { height:100%; margin:0; }
#map { width:100%; height:100%; }

.panel {
  position:absolute;
  top:10px; left:10px;
  background:white;
  padding:10px;
  border-radius:8px;
  box-shadow:0 0 6px rgba(0,0,0,.25);
  z-index:1000;
  width:260px;
  font-size:13px;
}

.panel h3 {
  margin:0 0 6px;
  font-size:14px;
}

.legend div {
  display:flex;
  align-items:center;
  margin-bottom:4px;
}
.box {
  width:12px;
  height:12px;
  border-radius:50%;
  margin-right:6px;
}

button {
  width:100%;
  margin-top:4px;
  padding:4px;
}

.step { background:#f44336; color:white; }
.curve { background:#2196f3; color:white; }
.hill { background:orange; color:white; }
.flat { background:#4caf50; color:white; }
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
  <h3>自動判定（表示）</h3>
  <label><input type="checkbox" id="f_step" checked> 段差</label><br>
  <label><input type="checkbox" id="f_curve" checked> カーブ</label><br>
  <label><input type="checkbox" id="f_hill" checked> 坂</label><br>
  <label><input type="checkbox" id="f_flat" checked> 平地</label>

  <hr>

  <h3>凡例（autoLabel）</h3>
  <div class="legend">
    <div><span class="box" style="background:red"></span>段差</div>
    <div><span class="box" style="background:blue"></span>カーブ</div>
    <div><span class="box" style="background:orange"></span>坂</div>
    <div><span class="box" style="background:green"></span>平地</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* ===== Firebase ===== */
const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* ===== Map ===== */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  .addTo(map);

let markers = [];

/* ===== Utils ===== */
function colorByLabel(l) {
  if (l === "step") return "red";
  if (l === "curve") return "blue";
  if (l === "hill") return "orange";
  if (l === "flat") return "green";
  return "#999";
}

/* ===== Load ===== */
async function loadEvents() {
  const snap = await getDocs(collection(db, "raw_events"));
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

/* ===== Draw ===== */
function draw(events) {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  if (!events.length) return;

  map.setView([events[0].lat, events[0].lng], 16);

  events.forEach(ev => {
    const color = colorByLabel(ev.autoLabel);

    const m = L.circleMarker([ev.lat, ev.lng], {
      radius: 7,
      color,
      fillColor: color,
      fillOpacity: 0.8
    }).addTo(map);

    m.meta = { autoLabel: ev.autoLabel };

    m.bindPopup(`
      <b>自動判定</b>: ${ev.autoLabel}<br>
      diffMax: ${ev.features.diffMax}<br>
      xyRatio: ${ev.features.xyRatio.toFixed(2)}<br>
      zRatio: ${ev.features.zRatio.toFixed(2)}<br>
      <hr>
      <b>正解入力</b><br>
      <button class="step" onclick="saveGT('${ev.id}','step')">段差</button>
      <button class="curve" onclick="saveGT('${ev.id}','curve')">カーブ</button>
      <button class="hill" onclick="saveGT('${ev.id}','hill')">坂</button>
      <button class="flat" onclick="saveGT('${ev.id}','flat')">平地</button>
    `);

    markers.push(m);
  });

  applyFilter();
}

/* ===== Filter ===== */
function applyFilter() {
  const fs = {
    step: document.getElementById("f_step").checked,
    curve: document.getElementById("f_curve").checked,
    hill: document.getElementById("f_hill").checked,
    flat: document.getElementById("f_flat").checked
  };

  markers.forEach(m => {
    if (fs[m.meta.autoLabel]) m.addTo(map);
    else map.removeLayer(m);
  });
}

["f_step","f_curve","f_hill","f_flat"].forEach(id =>
  document.getElementById(id).onchange = applyFilter
);

/* ===== Save GT ===== */
window.saveGT = async (eventId, gt) => {
  await addDoc(collection(db, "event_labels"), {
    eventId,
    groundTruth: gt,
    labeledAt: new Date().toISOString()
  });
  alert("正解ラベルを保存しました");
};

/* ===== Init ===== */
const events = await loadEvents();
draw(events);

</script>
</body>
</html>
