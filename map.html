<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Barrier Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
html, body { height:100%; margin:0; }
#map { width:100%; height:100%; }

/* ===== panel ===== */
.panel {
  position:absolute;
  top:10px; left:10px;
  background:white;
  padding:8px;
  border-radius:8px;
  box-shadow:0 0 6px rgba(0,0,0,.2);
  z-index:1000;
  width:220px;
}
.panel-header {
  font-weight:bold;
  margin-bottom:6px;
}
select { width:100%; }

/* ===== label buttons ===== */
.label-btn {
  margin:4px 2px;
  padding:4px 8px;
  border-radius:6px;
  border:1px solid #ccc;
  cursor:pointer;
}
.label-btn.active.step  { background:#e53935; color:white; }
.label-btn.active.curve { background:#1e88e5; color:white; }
.label-btn.active.flat  { background:#43a047; color:white; }
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div class="panel-header">セッション選択</div>
  <select id="sessionSelect"></select>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* ===== Firebase ===== */
const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* ===== Map ===== */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ===== util ===== */
function distance(a,b,c,d){
  const R=6371000;
  const dLat=(c-a)*Math.PI/180;
  const dLng=(d-b)*Math.PI/180;
  return 2*R*Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2
  ));
}

function markerColor(label){
  if(label==="step") return "red";
  if(label==="curve") return "blue";
  if(label==="flat") return "green";
  return "#333";
}

/* ===== load ===== */
async function loadSessions(){
  const snap = await getDocs(collection(db,"raw_sessions"));
  const sessions = [];
  snap.forEach(d=>{
    const s = d.data();
    if(s.logs){
      sessions.push({
        sessionId: s.sessionId,
        logs: s.logs.filter(l=>l.isEvent)
      });
    }
  });
  return sessions;
}

/* ===== UI ===== */
const sessionSelect = document.getElementById("sessionSelect");

/* ===== draw ===== */
let markers = [];

function clearMarkers(){
  markers.forEach(m=>map.removeLayer(m));
  markers = [];
}

function draw(session){
  clearMarkers();
  if(session.logs.length === 0) return;

  /* --- グルーピング --- */
  const groups = [];
  session.logs.forEach(p=>{
    let g = groups.find(g =>
      distance(p.lat,p.lng,g.lat,g.lng) < 6 &&
      Math.abs(p.z - g.avgZ) < 2
    );

    if(!g){
      groups.push({
        lat:p.lat,
        lng:p.lng,
        count:1,
        avgZ:p.z,
        maxDiff:p.diff,
        maxAngle:p.angleDiff,
        typeCount:{ [p.type]:1 }
      });
    }else{
      g.count++;
      g.avgZ += (p.z - g.avgZ)/g.count;
      g.maxDiff = Math.max(g.maxDiff, p.diff);
      g.maxAngle = Math.max(g.maxAngle, p.angleDiff);
      g.typeCount[p.type]=(g.typeCount[p.type]||0)+1;
    }
  });

  function detectedType(g){
    if((g.typeCount.step||0)/g.count >= 0.6) return "step";
    if((g.typeCount.curve||0)>0) return "curve";
    return "flat";
  }

  map.setView([groups[0].lat,groups[0].lng],16);

  groups.forEach(g=>{
    const detected = detectedType(g);
    let currentLabel = null;

    const marker = L.circleMarker([g.lat,g.lng],{
      radius:8,
      color:"#333",
      fillColor:"#333",
      fillOpacity:0.7
    }).addTo(map);

    function popupHTML(active){
      return `
        <b>機械判定：</b>${detected}<br>
        diff最大：${g.maxDiff.toFixed(1)}<br>
        z平均：${g.avgZ.toFixed(1)}<br>
        angle最大：${g.maxAngle.toFixed(1)}<br><br>

        <b>正解ラベル</b><br>
        <button class="label-btn step ${active==="step"?"active step":""}">段差</button>
        <button class="label-btn curve ${active==="curve"?"active curve":""}">カーブ</button>
        <button class="label-btn flat ${active==="flat"?"active flat":""}">平地</button>
      `;
    }

    marker.bindPopup(popupHTML(null));

    marker.on("popupopen", e=>{
      const el = e.popup.getElement();
      el.querySelectorAll(".label-btn").forEach(btn=>{
        btn.onclick = async ()=>{
          const label =
            btn.classList.contains("step") ? "step" :
            btn.classList.contains("curve") ? "curve" : "flat";

          const newLabel = (label===currentLabel) ? null : label;
          currentLabel = newLabel;

          marker.setStyle({
            color: markerColor(newLabel),
            fillColor: markerColor(newLabel)
          });

          marker.setPopupContent(popupHTML(newLabel));

          if(newLabel){
            await addDoc(collection(db,"labels"),{
              lat:g.lat,
              lng:g.lng,
              label_true:newLabel,
              type_detected:detected,
              diff:g.maxDiff,
              z:g.avgZ,
              angleDiff:g.maxAngle,
              sessionId: session.sessionId,
              updatedAt:new Date().toISOString()
            });
          }
        };
      });
    });

    markers.push(marker);
  });
}

/* ===== init ===== */
const sessions = await loadSessions();

sessionSelect.innerHTML = "";
sessions.forEach((s,i)=>{
  const o = document.createElement("option");
  o.value = i;
  o.textContent = s.sessionId;
  sessionSelect.appendChild(o);
});

sessionSelect.onchange = e => {
  draw(sessions[e.target.value]);
};

draw(sessions[0]);
</script>
</body>
</html>
