<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Barrier Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
html, body { height:100%; margin:0; }
#map { width:100%; height:100%; }

.label-btn {
  margin:4px 2px;
  padding:4px 8px;
  border-radius:6px;
  border:1px solid #ccc;
  cursor:pointer;
}
.label-btn.active.step  { background:#ff4d4d; color:white; }
.label-btn.active.curve { background:#4d79ff; color:white; }
.label-btn.active.flat  { background:#4caf50; color:white; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc,
  query,
  where
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* ===== Firebase ===== */
const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* ===== Map ===== */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ===== util ===== */
function distance(a,b,c,d){
  const R=6371000;
  const dLat=(c-a)*Math.PI/180;
  const dLng=(d-b)*Math.PI/180;
  return 2*R*Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2
  ));
}

function markerColor(label){
  if(label==="step") return "#ff4d4d";
  if(label==="curve") return "#4d79ff";
  if(label==="flat") return "#4caf50";
  return "#000";
}

/* ===== load raw events ===== */
async function loadEvents(){
  const snap = await getDocs(collection(db,"raw_sessions"));
  const arr = [];
  snap.forEach(d=>{
    d.data().logs?.forEach(l=>{
      if(l.isEvent){
        arr.push({...l});
      }
    });
  });
  return arr;
}

/* ===== label helpers ===== */
async function getLabel(lat,lng){
  const q = query(
    collection(db,"labels"),
    where("lat","==",lat),
    where("lng","==",lng)
  );
  const snap = await getDocs(q);
  if(snap.empty) return null;
  return snap.docs[0].data();
}

async function saveLabel(lat,lng,label){
  const existing = await getLabel(lat,lng);

  // 同じラベル → 解除
  if(existing?.label_true === label){
    await addDoc(collection(db,"labels"),{
      lat,lng,
      label_true:null,
      updatedAt:new Date().toISOString()
    });
    return null;
  }

  await addDoc(collection(db,"labels"),{
    lat,lng,
    label_true:label,
    updatedAt:new Date().toISOString()
  });
  return label;
}

/* ===== main ===== */
const data = await loadEvents();

/* 簡易クラスタ */
const groups = [];
data.forEach(p=>{
  let g = groups.find(g=>distance(p.lat,p.lng,g.lat,g.lng)<5);
  const accel = Math.sqrt(p.x*p.x + p.y*p.y + p.z*p.z);

  if(!g){
    groups.push({
      lat:p.lat,
      lng:p.lng,
      accelSum: accel,
      dz: Math.abs(p.z),
      detected: p.type
    });
  }else{
    g.accelSum += accel;
    g.dz = Math.max(g.dz, Math.abs(p.z));
  }
});

map.setView([groups[0].lat,groups[0].lng],16);

for(const g of groups){
  const labelData = await getLabel(g.lat,g.lng);
  const current = labelData?.label_true ?? null;

  const marker = L.circleMarker([g.lat,g.lng],{
    radius:8,
    color: markerColor(current),
    fillColor: markerColor(current),
    fillOpacity:0.8
  }).addTo(map);

  function popupHTML(active){
    return `
      <b>イベント情報</b><br>
      加速度合計：${g.accelSum.toFixed(1)}<br>
      dz：${g.dz.toFixed(2)}<br>
      機械判定：${g.detected ?? "なし"}<br>
      <hr>
      <b>正解ラベル</b><br>
      <button class="label-btn step ${active==="step"?"active step":""}">段差</button>
      <button class="label-btn curve ${active==="curve"?"active curve":""}">カーブ</button>
      <button class="label-btn flat ${active==="flat"?"active flat":""}">平地</button>
    `;
  }

  marker.bindPopup(popupHTML(current));

  marker.on("popupopen", e=>{
    const el = e.popup.getElement();
    el.querySelectorAll(".label-btn").forEach(btn=>{
      btn.onclick = async ()=>{
        const label = btn.classList.contains("step")
          ? "step"
          : btn.classList.contains("curve")
          ? "curve"
          : "flat";

        const newLabel = await saveLabel(g.lat,g.lng,label);

        marker.setStyle({
          color: markerColor(newLabel),
          fillColor: markerColor(newLabel)
        });

        marker.setPopupContent(popupHTML(newLabel));
      };
    });
  });
}
</script>
</body>
</html>
