<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Barrier Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
html, body { height:100%; margin:0; }
#map { width:100%; height:100%; }

.panel {
  position:absolute;
  top:10px; left:10px;
  background:white;
  padding:8px;
  border-radius:8px;
  box-shadow:0 0 6px rgba(0,0,0,.2);
  z-index:1000;
  width:210px;
}

.panel-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:bold;
}

.panel-body { margin-top:6px; }
.hidden { display:none; }

button, select {
  width:100%;
  margin-top:4px;
}

.levelBtn.active {
  background:#007bff;
  color:white;
}

.legend { font-size:12px; margin-top:6px; }
.box { width:12px; height:12px; display:inline-block; border-radius:50%; margin-right:4px; }

#noData {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:white;
  padding:12px 20px;
  border-radius:8px;
  box-shadow:0 0 8px rgba(0,0,0,.3);
  font-weight:bold;
  display:none;
}

.label-btn {
  margin:4px 2px;
  padding:4px 8px;
  border-radius:6px;
  border:1px solid #ccc;
  cursor:pointer;
}
.label-btn.active.step  { background:#e53935; color:white; }
.label-btn.active.curve { background:#1e88e5; color:white; }
.label-btn.active.flat  { background:#43a047; color:white; }
</style>
</head>
<body>

<div id="map"></div>
<div id="noData">データがありません</div>

<div class="panel">
  <div class="panel-header">
    <span>表示設定</span>
    <button id="toggleBtn">▼</button>
  </div>

  <div class="panel-body" id="panelBody">
    <b>セッション</b>
    <select id="sessionSelect"></select>

    <hr>

    <label><input type="checkbox" id="showStep" checked> 段差</label><br>
    <label><input type="checkbox" id="showCurve" checked> カーブ</label>

    <hr>

    <b>段差信頼度</b>
    <button class="levelBtn" data-level="0.6">6割</button>
    <button class="levelBtn active" data-level="0.7">7割</button>
    <button class="levelBtn" data-level="0.8">8割</button>

    <div class="legend">
      <div><span class="box" style="background:red"></span>段差</div>
      <div><span class="box" style="background:blue"></span>カーブ</div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* ===== Firebase ===== */
const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* ===== Map ===== */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ===== util ===== */
function distance(a,b,c,d){
  const R=6371000;
  const dLat=(c-a)*Math.PI/180;
  const dLng=(d-b)*Math.PI/180;
  return 2*R*Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2
  ));
}

function markerColor(label){
  if(label==="step") return "red";
  if(label==="curve") return "blue";
  if(label==="flat") return "green";
  return "#333";
}

/* ===== load ===== */
async function load(){
  const snap = await getDocs(collection(db,"raw_sessions"));
  const arr = [];
  snap.forEach(d=>{
    d.data().logs?.forEach(l=>{
      if(l.isEvent) arr.push({...l, sessionId:d.data().sessionId});
    });
  });
  return arr;
}

/* ===== state ===== */
let allData = [], markers = [];
let selectedSession = "all", level = 0.7;

/* ===== UI ===== */
const showStep = document.getElementById("showStep");
const showCurve = document.getElementById("showCurve");
const noDataBox = document.getElementById("noData");

document.getElementById("toggleBtn").onclick = () => {
  document.getElementById("panelBody").classList.toggle("hidden");
};

document.querySelectorAll(".levelBtn").forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll(".levelBtn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    level = parseFloat(b.dataset.level);
    draw();
  };
});

document.getElementById("sessionSelect").onchange = e=>{
  selectedSession = e.target.value;
  draw();
};

showStep.onchange = showCurve.onchange = draw;

/* ===== draw ===== */
function draw(){
  markers.forEach(m=>map.removeLayer(m));
  markers = [];

  let data = allData.filter(d => selectedSession==="all" || d.sessionId===selectedSession);
  if(!showStep.checked) data = data.filter(d=>d.type!=="step");
  if(!showCurve.checked) data = data.filter(d=>d.type!=="curve");

  if(data.length===0){
    noDataBox.style.display = "block";
    return;
  } else {
    noDataBox.style.display = "none";
  }

  const groups = [];

  data.forEach(p=>{
    let g = groups.find(g=>{
      const d = distance(p.lat,p.lng,g.lat,g.lng);
      const dz = Math.abs(p.z - g.avgZ || 0);
      return d<5;
    });

    if(!g){
      groups.push({
        lat:p.lat, lng:p.lng, avgZ:p.z, count:1,
        sumDiff:p.diff, maxDiff:p.diff, typeCount:{[p.type]:1}
      });
    } else {
      g.count++;
      g.sumDiff += p.diff;
      g.maxDiff = Math.max(g.maxDiff,p.diff);
      g.typeCount[p.type] = (g.typeCount[p.type]||0)+1;
      g.avgZ = g.avgZ + (p.z - g.avgZ)/g.count;
    }
  });

  map.setView([groups[0].lat,groups[0].lng],16);

  groups.forEach(g=>{
    let type="curve", color="blue";
    const ratio=(g.typeCount.step||0)/g.count;

    if(ratio>=level){
      type="step"; color="red";
    } else {
      type="curve"; color="blue";
    }

    const m = L.circleMarker([g.lat,g.lng],{
      radius:8, color, fillColor: color, fillOpacity:0.7
    }).addTo(map);

    function popupHTML(activeLabel=null){
      return `
        <b>${type==="step"?"段差":"カーブ"}</b><br>
        検出数：${g.count}<br>
        平均diff：${(g.sumDiff/g.count).toFixed(2)}<br>
        最大diff：${g.maxDiff.toFixed(2)}<br><br>

        <b>正解ラベル</b><br>
        <button class="label-btn step ${activeLabel==="step"?"active step":""}">段差</button>
        <button class="label-btn curve ${activeLabel==="curve"?"active curve":""}">カーブ</button>
        <button class="label-btn flat ${activeLabel==="flat"?"active flat":""}">平地</button><br><br>

        <a href="detail.html?lat=${g.lat}&lng=${g.lng}" target="_blank">詳細データを見る</a>
      `;
    }

    m.bindPopup(popupHTML());

    m.on("popupopen", e=>{
      const el = e.popup.getElement();
      el.querySelectorAll(".label-btn").forEach(btn=>{
        btn.onclick = async ()=>{
          const label = btn.classList.contains("step") ? "step" :
                        btn.classList.contains("curve") ? "curve" : "flat";

          m.setStyle({ color: markerColor(label), fillColor: markerColor(label) });
          m.setPopupContent(popupHTML(label));

          await addDoc(collection(db,"labels"),{
            lat:g.lat,
            lng:g.lng,
            label_true:label,
            type_detected:type,
            avgDiff:g.sumDiff/g.count,
            maxDiff:g.maxDiff,
            sessionId:selectedSession,
            updatedAt:new Date().toISOString()
          });
        };
      });
    });

    markers.push(m);
  });
}

/* ===== init ===== */
allData = await load();

const sel=document.getElementById("sessionSelect");
sel.innerHTML='<option value="all">すべて</option>';
[...new Set(allData.map(d=>d.sessionId))].forEach(s=>{
  const o=document.createElement("option");
  o.value=s; o.textContent=s;
  sel.appendChild(o);
});

draw();
</script>
</body>
</html> 