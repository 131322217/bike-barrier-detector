<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Barrier Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
html, body { height:100%; margin:0; }
#map { width:100%; height:100%; }

.panel {
  position:absolute;
  top:10px;
  left:10px;
  background:white;
  padding:8px;
  border-radius:8px;
  box-shadow:0 0 6px rgba(0,0,0,.2);
  z-index:1000;
}

.label-btn {
  margin:4px 2px;
  padding:4px 8px;
  border-radius:6px;
  border:1px solid #ccc;
  cursor:pointer;
}
.label-btn.active.step  { background:#e53935; color:white; }
.label-btn.active.curve { background:#1e88e5; color:white; }
.label-btn.active.flat  { background:#43a047; color:white; }
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <b>Session</b><br>
  <select id="sessionSelect"></select>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* ===== Firebase ===== */
const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* ===== Map ===== */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ===== util ===== */
function distance(a,b,c,d){
  const R=6371000;
  const dLat=(c-a)*Math.PI/180;
  const dLng=(d-b)*Math.PI/180;
  return 2*R*Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2
  ));
}

function markerColor(label){
  if(label==="step") return "red";
  if(label==="curve") return "blue";
  if(label==="flat") return "green";
  return "#333";
}

/* ===== load raw events (sessionId付き) ===== */
async function loadEvents(){
  const snap = await getDocs(collection(db,"raw_sessions"));
  const arr = [];
  snap.forEach(d=>{
    const sessionId = d.data().sessionId;
    d.data().logs?.forEach(l=>{
      if(l.isEvent){
        arr.push({
          ...l,
          sessionId
        });
      }
    });
  });
  return arr;
}

/* ===== state ===== */
let allRaw = [];
let currentSession = "all";
let markers = [];

/* ===== UI ===== */
const sessionSelect = document.getElementById("sessionSelect");
sessionSelect.onchange = e => {
  currentSession = e.target.value;
  draw();
};

/* ===== draw ===== */
function clearMarkers(){
  markers.forEach(m=>map.removeLayer(m));
  markers = [];
}

function draw(){
  clearMarkers();

  const source =
    currentSession === "all"
      ? allRaw
      : allRaw.filter(p => p.sessionId === currentSession);

  if(source.length === 0) return;

  /* --- グルーピング（そのまま） --- */
  const groups = [];
  source.forEach(p=>{
    let g = groups.find(g =>
      distance(p.lat,p.lng,g.lat,g.lng) < 6 &&
      Math.abs(p.z - g.avgZ) < 2
    );

    if(!g){
      groups.push({
        lat:p.lat,
        lng:p.lng,
        count:1,
        avgZ:p.z,
        maxDiff:p.diff,
        maxAngle:p.angleDiff,
        typeCount:{ [p.type]:1 }
      });
    }else{
      g.count++;
      g.avgZ += (p.z - g.avgZ)/g.count;
      g.maxDiff = Math.max(g.maxDiff, p.diff);
      g.maxAngle = Math.max(g.maxAngle, p.angleDiff);
      g.typeCount[p.type]=(g.typeCount[p.type]||0)+1;
    }
  });

  function detectedType(g){
    if((g.typeCount.step||0)/g.count >= 0.6) return "step";
    if((g.typeCount.curve||0)>0) return "curve";
    return "candidate";
  }

  map.setView([groups[0].lat,groups[0].lng],16);

  groups.forEach(g=>{
    const detected = detectedType(g);
    let currentLabel = null;

    const marker = L.circleMarker([g.lat,g.lng],{
      radius:8,
      color:"#333",
      fillColor:"#333",
      fillOpacity:0.7
    }).addTo(map);

    function popupHTML(active){
      return `
        <b>機械判定：</b>${detected}<br>
        diff最大：${g.maxDiff.toFixed(1)}<br>
        z平均：${g.avgZ.toFixed(1)}<br>
        angle最大：${g.maxAngle.toFixed(1)}<br><br>

        <b>正解ラベル</b><br>
        <button class="label-btn step ${active==="step"?"active step":""}">段差</button>
        <button class="label-btn curve ${active==="curve"?"active curve":""}">カーブ</button>
        <button class="label-btn flat ${active==="flat"?"active flat":""}">平地</button>
      `;
    }

    marker.bindPopup(popupHTML(null));

    marker.on("popupopen", e=>{
      const el = e.popup.getElement();
      el.querySelectorAll(".label-btn").forEach(btn=>{
        btn.onclick = async ()=>{
          const label =
            btn.classList.contains("step") ? "step" :
            btn.classList.contains("curve") ? "curve" : "flat";

          currentLabel = label;

          marker.setStyle({
            color: markerColor(label),
            fillColor: markerColor(label)
          });

          marker.setPopupContent(popupHTML(label));

          await addDoc(collection(db,"labels"),{
            lat:g.lat,
            lng:g.lng,
            label_true:label,
            type_detected:detected,
            diff:g.maxDiff,
            z:g.avgZ,
            angleDiff:g.maxAngle,
            sessionId: currentSession,
            updatedAt:new Date().toISOString()
          });
        };
      });
    });

    markers.push(marker);
  });
}

/* ===== init ===== */
allRaw = await loadEvents();

/* session selector */
sessionSelect.innerHTML = '<option value="all">all</option>';
[...new Set(allRaw.map(d=>d.sessionId))].forEach(id=>{
  const o=document.createElement("option");
  o.value=id;
  o.textContent=id;
  sessionSelect.appendChild(o);
});

draw();
</script>
</body>
</html>
