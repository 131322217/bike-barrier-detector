<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Barrier Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
html, body { height:100%; margin:0; }
#map { width:100%; height:100%; }

.panel {
  position:absolute;
  top:10px; left:50px;
  background:white;
  padding:8px;
  border-radius:8px;
  box-shadow:0 0 6px rgba(0,0,0,.2);
  z-index:1000;
  width:220px;
}

.panel-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:bold;
}

.panel-body { margin-top:6px; }
.hidden { display:none; }

button { width:100%; margin-top:4px; }

.label-btn { padding:4px; }
.step { background:#4caf50; color:white; }
.curve { background:#ff9800; color:white; }
.flat { background:#607d8b; color:white; }

#noData {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:white;
  padding:12px 20px;
  border-radius:8px;
  box-shadow:0 0 8px rgba(0,0,0,.3);
  font-weight:bold;
  display:none;
}
.legend {
  margin-top: 10px;
  font-size: 12px;
}

.legend div {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
}

.box {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 6px;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="noData">データがありません</div>

<div class="panel">
  <div class="panel-header">
    <span>表示設定</span>
    <button id="toggleBtn">▼</button>
  </div>

  <div class="panel-body" id="panelBody">
    <b>セッション</b>
    <select id="sessionSelect"></select>

    <hr>

    <b>diff</b><br>
    <label><input type="checkbox" id="show45" checked>45+</label><br>
    <label><input type="checkbox" id="show50" checked>50+</label><br>
    <label><input type="checkbox" id="show55" checked>55+</label><br>
    <label><input type="checkbox" id="show60" checked>60+</label>

    <hr>

    <b>Z軸</b><br>
    <label><input type="checkbox" id="z10" checked>10–15</label><br>
    <label><input type="checkbox" id="z15" checked>15–20</label><br>
    <label><input type="checkbox" id="z20" checked>20–25</label><br>
    <label><input type="checkbox" id="z25" checked>25+</label>
  </div>
  <div class="legend"> 
    <div>
      <span class="box" style="background:blue"></span>45+</div> 
      <div><span class="box" style="background:red"></span>50+</div> 
      <div><span class="box" style="background:rgb(31,180,31)"></span>55+</div> 
      <div><span class="box" style="background:rgb(175,30,175)"></span>60+</div> 
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* Map */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* Utils */
function distance(a,b,c,d){
  const R=6371000;
  const dLat=(c-a)*Math.PI/180;
  const dLng=(d-b)*Math.PI/180;
  return 2*R*Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2
  ));
}

function markerColor(d){
  if(d>=60) return "rgb(175,30,175)";
  if(d>=55) return "rgb(31,180,31)";
  if(d>=50) return "red";
  return "blue";
}

/* Load */
async function load(){
  const snap = await getDocs(collection(db,"raw_sessions"));
  const arr=[];
  snap.forEach(d=>{
    d.data().logs?.forEach(l=>{
      if(l.isEvent) arr.push({...l, sessionId:d.data().sessionId});
    });
  });
  return arr;
}

let allData=[], markers=[];
let selectedSession="all";

/* UI */
const ids = ["show45","show50","show55","show60","z10","z15","z20","z25"];
ids.forEach(id=>document.getElementById(id).onchange=draw);

document.getElementById("toggleBtn").onclick=()=>{
  document.getElementById("panelBody").classList.toggle("hidden");
};

document.getElementById("sessionSelect").onchange=e=>{
  selectedSession=e.target.value;
  draw();
};

/* Draw */
function draw(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  let data = allData.filter(d =>
    selectedSession==="all" || d.sessionId===selectedSession
  );

  data = data.filter(d=>{
    const diffOK =
      (d.diff>=60 && show60.checked) ||
      (d.diff>=55 && show55.checked) ||
      (d.diff>=50 && show50.checked) ||
      (d.diff>=45 && show45.checked);

    const z = Math.abs(d.z);
    const zOK =
      (z>=10 && z<15 && z10.checked) ||
      (z>=15 && z<20 && z15.checked) ||
      (z>=20 && z<25 && z20.checked) ||
      (z>=25 && z25.checked);

    return diffOK && zOK;
  });

  if(!data.length){
    document.getElementById("noData").style.display="block";
    return;
  }
  document.getElementById("noData").style.display="none";

  const groups=[];
  data.forEach(p=>{
    let g=groups.find(g=>distance(p.lat,p.lng,g.lat,g.lng)<5);
    if(!g){
      groups.push({lat:p.lat,lng:p.lng,samples:[p]});
    }else g.samples.push(p);
  });

  map.setView([groups[0].lat,groups[0].lng],16);

  groups.forEach(g=>{
    const avg=g.samples.reduce((a,b)=>a+b.diff,0)/g.samples.length;
    const max=Math.max(...g.samples.map(s=>s.diff));

    const m=L.circleMarker([g.lat,g.lng],{
      radius:7,
      color:markerColor(avg),
      fillColor:markerColor(avg),
      fillOpacity:0.7
    }).addTo(map);

    const avgX = g.samples.reduce((a,b)=>a+b.x,0)/g.samples.length;
  const avgY = g.samples.reduce((a,b)=>a+b.y,0)/g.samples.length;
  const avgZ = g.samples.reduce((a,b)=>a+b.z,0)/g.samples.length;

    m.bindPopup(`
      <b>検出</b><br>
      件数:${g.samples.length}<br>
      avg:${avg.toFixed(2)}<br>
      max:${max.toFixed(2)}<br><br>

      <b>平均加速度</b><br>
      X：${avgX.toFixed(2)}<br>
      Y：${avgY.toFixed(2)}<br>
      Z：${avgZ.toFixed(2)}<br><br>

      <button class="label-btn step" onclick="saveLabel(${g.lat},${g.lng},'step')">段差</button>
      <button class="label-btn curve" onclick="saveLabel(${g.lat},${g.lng},'curve')">カーブ</button>
      <button class="label-btn flat" onclick="saveLabel(${g.lat},${g.lng},'flat')">平地</button>
    `);

    markers.push(m);
  });
}

/* Save */
window.saveLabel = async (lat,lng,label)=>{
  const samples = allData.filter(d=>distance(lat,lng,d.lat,d.lng)<5);
  const avg = samples.reduce((a,b)=>a+b.diff,0)/samples.length;

  await addDoc(collection(db,"labels"),{
    lat,lng,
    avgDiff:avg,
    maxDiff:Math.max(...samples.map(s=>s.diff)),
    label_true:label,
    type_detected:label,
    samples:samples.map(s=>({
      diff:s.diff,x:s.x,y:s.y,z:s.z
    })),
    sessionId:"all",
    updatedAt:new Date().toISOString()
  });

  alert("保存しました");
};

allData = await load();

const sel=document.getElementById("sessionSelect");
sel.innerHTML='<option value="all">すべて</option>';
[...new Set(allData.map(d=>d.sessionId))].forEach(s=>{
  const o=document.createElement("option");
  o.value=s; o.textContent=s;
  sel.appendChild(o);
});

draw();
</script>
</body>
</html>
