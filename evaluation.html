<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>散布図切替</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: sans-serif; margin:20px; text-align:center; }
canvas { max-width:900px; margin:20px auto; display:block; }
button { margin:5px; padding:6px 12px; border-radius:4px; cursor:pointer; }
</style>
</head>
<body>

<h1>散布図切替</h1>
<canvas id="scatterChart"></canvas>

<div>
  <button data-x="diff" data-y="angleDiff">diff × angleDiff</button>
  <button data-x="diff" data-y="z">diff × z</button>
  <button data-x="diff" data-y="x">diff × x</button>
  <button data-x="diff" data-y="y">diff × y</button>
  <button data-x="diff" data-y="xyMean">diff × |x+y|/2</button>
  <button data-x="xyMean" data-y="z">|x+y|/2 × z</button>
  <button data-x="angleDiff" data-y="xyMean">angleDiff × |x+y|/2</button>
  <button data-x="x" data-y="y">x × y</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* ラベル定義 */
const KEYS = ["step","curve","flat"];
const LABEL = { step:"段差", curve:"カーブ", flat:"平地" };
const COLOR = { step:"rgba(220,38,38,0.7)", curve:"rgba(37,99,235,0.7)", flat:"rgba(34,197,94,0.7)" };

/* データ取得 */
const snap = await getDocs(collection(db,"labels"));
let rows = snap.docs.map(d => {
  const r = d.data();
  return {
    ...r,
    xyMean: (typeof r.x==="number" && typeof r.y==="number") ? (Math.abs(r.x) + Math.abs(r.y))/2 : null
  };
});
if(rows.length === 0) alert("labels にデータがありません");

/* 初期散布図描画 */
const ctx = document.getElementById("scatterChart").getContext("2d");
let chart;

function drawScatter(xField, yField){
  const datasets = KEYS.map(k => ({
    label: LABEL[k],
    backgroundColor: COLOR[k],
    data: rows
      .filter(r => r.label_true===k && typeof r[xField]==="number" && typeof r[yField]==="number")
      .map(r => ({ x: r[xField], y: r[yField] }))
  }));

  if(chart) chart.destroy(); // 前のチャート削除
  chart = new Chart(ctx, {
    type:'scatter',
    data: { datasets },
    options: {
      responsive:true,
      plugins:{ legend:{ position:"top" } },
      scales:{
        x:{ title:{ display:true, text: xField } },
        y:{ title:{ display:true, text: yField } }
      }
    }
  });
}

/* 初期表示 */
drawScatter("diff","angleDiff");

/* ボタン切替 */
document.querySelectorAll("button").forEach(btn=>{
  btn.onclick = ()=> drawScatter(btn.dataset.x, btn.dataset.y);
});
</script>

</body>
</html>
