<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Step Detection Dashboard - Final Ver</title>
<script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>
<style>
  body { font-family: -apple-system, sans-serif; margin: 0; background: #f4f7f9; color: #333; }
  .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
  header { background: #1a73e8; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
  .nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
  button { padding: 12px 20px; border: none; border-radius: 8px; background: white; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  button.active { background: #1a73e8; color: white; }
  .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); height: 550px; position: relative; }
  .info-tag { position: absolute; top: 10px; right: 20px; background: #e8f0fe; color: #1a73e8; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid #1a73e8; }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1 style="margin:0; font-size:20px;">段差検出：評価ダッシュボード</h1>
    <p style="margin:5px 0 0 0; opacity:0.8; font-size:13px;">正規版ロジック（カーブ0件表示・n数表示対応）</p>
  </header>
  <div class="nav">
    <button id="btn1" class="active">① 特徴量分布 (正解別)</button>
    <button id="btn2">② F1感度分析</button>
    <button id="btn3">③ 導入効果</button>
  </div>
  <div class="chart-card">
    <div id="bestRadiusTag" class="info-tag" style="display:none;"></div>
    <div id="plot" style="width:100%; height:100%;"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const app = initializeApp({ apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo", projectId: "bike-barrier-detector-1e128" });
const db = getFirestore(app);

const FIXED_DIFF = 50, FIXED_ZRATIO = 0.60;
let allData = [];
let bestR = 0, bestF1 = 0;

function getBasePred(f) {
  if (!f) return "other";
  return (f.diffMax >= FIXED_DIFF && f.zRatio >= FIXED_ZRATIO && !f.zConsistency) ? "step" : "other";
}
function getDist(e1, e2) {
  const R = 6371000, dLat = (e2.lat - e1.lat) * Math.PI / 180, dLon = (e2.lng - e1.lng) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(e1.lat*Math.PI/180) * Math.cos(e2.lat*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function getFinalPred(target, rad, pool) {
  const base = getBasePred(target.features);
  if (rad <= 0 || base === "other") return base;
  const neighbors = pool.filter(n => 
    n.id !== target.id && getDist(target, n) <= rad && n.features && typeof n.features.diffMax !== 'undefined'
  );
  if (neighbors.length > 0) {
    const stepCount = neighbors.filter(n => getBasePred(n.features) === "step").length;
    if (stepCount / neighbors.length <= 0.5) return "other";
  }
  return "step";
}

async function init() {
  const [eSnap, lSnap] = await Promise.all([getDocs(collection(db, "raw_events")), getDocs(collection(db, "event_labels"))]);
  
  const gtMap = {};
  lSnap.forEach(d => { gtMap[d.data().eventId] = d.data().groundTruth; });
  
  allData = eSnap.docs.map(d => ({
    id: d.id, lat: d.data().lat, lng: d.data().lng, 
    features: d.data().features || {}, 
    // DBにないラベルは "flat" (平地) 扱いにする
    gt: gtMap[d.id] || "flat" 
  }));

  let maxF1 = -1;
  for (let r = 0; r <= 15; r += 0.5) {
    const m = calcMetrics(r);
    if (m.f1 > maxF1) { maxF1 = m.f1; bestR = r; bestF1 = m.f1; }
  }
  document.getElementById("bestRadiusTag").style.display = "block";
  document.getElementById("bestRadiusTag").textContent = `最適半径: ${bestR}m (F1: ${bestF1.toFixed(3)})`;
  
  drawScatter();
}

function calcMetrics(rad) {
  let tp=0, fp=0, fn=0;
  allData.forEach(ev => {
    const truth = ev.gt === "step" ? "step" : "other"; 
    const pred = getFinalPred(ev, rad, allData) === "step" ? "step" : "other";
    if (pred === "step" && truth === "step") tp++; 
    else if (pred === "step" && truth !== "step") fp++; 
    else if (pred !== "step" && truth === "step") fn++;
  });
  const p = tp/(tp+fp||1), r = tp/(tp+fn||1);
  return { p, r, f1: (2*p*r/(p+r||1)) };
}

// ★修正版：散布図（Graph 1）
function drawScatter() {
  const categories = [
    { key: "step",  label: "段差",   color: "#dc3545" }, // 赤
    { key: "curve", label: "カーブ", color: "#1a73e8" }, // 青
    { key: "hill",  label: "坂",     color: "#f9ab00" }, // 黄色
    { key: "flat",  label: "平地",   color: "#28a745" }  // 緑
  ];

  const traces = categories.map(cat => {
    const d = allData.filter(r => r.gt === cat.key);
    return { 
      x: d.map(r => r.features.diffMax || 0), 
      y: d.map(r => r.features.zRatio || 0), 
      mode: 'markers', 
      // 0件でも強制表示
      name: `${cat.label} (${d.length})`, 
      showlegend: true, 
      marker: {
        color: cat.color,
        size: 7, opacity: 0.7,
        line: { width: 1, color: 'white' }
      },
      type: 'scatter'
    };
  });

  Plotly.newPlot('plot', traces, { 
    title: '特徴量分布 (正解ラベル別)', 
    xaxis: {title: 'diffMax (衝撃強度)', range:[0, 200]}, 
    yaxis: {title: 'zRatio (垂直成分比)', range:[0, 1.3]}, 
    shapes: [{ 
      type: 'rect', x0: FIXED_DIFF, y0: FIXED_ZRATIO, x1: 300, y1: 1.5, 
      line: {color: 'red', dash: 'dash', width: 2}, fillcolor: 'rgba(255,0,0,0.05)' 
    }],
    legend: { title: { text: '正解ラベル(件数)' } },
    // ★追加：右上に n=xxx を表示
    annotations: [{
      text: `n = ${allData.length}`,
      x: 1, y: 1.05, 
      xref: 'paper', yref: 'paper',
      showarrow: false,
      font: { size: 14, color: '#555', family: 'Arial, sans-serif' }
    }]
  });
}

function drawSensitivity() {
  const radii = []; for(let r=0; r<=15; r+=0.5) radii.push(r);
  const f1s = radii.map(r => calcMetrics(r).f1);
  Plotly.newPlot('plot', [
    { x: radii, y: f1s, mode: 'lines+markers', name: 'F1 Score', line: {shape: 'spline', color: '#1a73e8'} },
    { x: [bestR], y: [bestF1], mode: 'markers', name: 'Best', marker: {color: 'red', size: 12} }
  ], { title: '半径ごとのF1スコア変化', xaxis: {title: '半径(m)'}, yaxis: {range:[0,1]} });
}

function drawComp() {
  const m0 = calcMetrics(0), mOpt = calcMetrics(bestR);
  Plotly.newPlot('plot', [
    { x: ['Prec','Recall','F1'], y: [m0.p, m0.r, m0.f1], name: '0m (Raw)', type: 'bar' },
    { x: ['Prec','Recall','F1'], y: [mOpt.p, mOpt.r, mOpt.f1], name: `${bestR}m (Filtered)`, type: 'bar' }
  ], { title: '導入効果', barmode: 'group', yaxis: {range:[0,1]} });
}

document.getElementById("btn1").onclick = (e) => { switchTab(e); drawScatter(); };
document.getElementById("btn2").onclick = (e) => { switchTab(e); drawSensitivity(); };
document.getElementById("btn3").onclick = (e) => { switchTab(e); drawComp(); };
function switchTab(e) { document.querySelectorAll('button').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); }

init();
</script>
</body>
</html>