<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>散布図切替（Plotly版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>
<style>
body { font-family: sans-serif; margin:20px; text-align:center; }
#scatterPlot { width:90%; max-width:1000px; height:600px; margin:20px auto; }
button { margin:5px; padding:6px 12px; border-radius:4px; cursor:pointer; }
</style>
</head>
<body>

<h1>散布図切替（Plotly版）</h1>
<div id="scatterPlot"></div>

<div>
  <button data-x="diff" data-y="angleDiff">diff × angleDiff</button>
  <button data-x="diff" data-y="z">diff × z</button>
  <button data-x="diff" data-y="x">diff × x</button>
  <button data-x="diff" data-y="y">diff × y</button>
  <button data-x="diff" data-y="xyMean">diff × |x+y|/2</button>
  <button data-x="xyMean" data-y="z">|x+y|/2 × z</button>
  <button data-x="angleDiff" data-y="xyMean">angleDiff × |x+y|/2</button>
  <button data-x="x" data-y="y">x × y</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* ラベル定義 */
const KEYS = ["step","curve","flat"];
const LABEL = { step:"段差", curve:"カーブ", flat:"カーブ+段差" };
const COLOR = { step:"red", curve:"blue", flat:"green" };

/* データ取得 */
const snap = await getDocs(collection(db,"labels"));
let rows = [];
snap.docs.forEach(d => {
  const r = d.data();
  if(r.samples?.length){
    r.samples.forEach(s=>{
      rows.push({...r,...s, xyMean:(Math.abs(s.x)+Math.abs(s.y))/2});
    });
  } else {
    rows.push({...r, xyMean:(Math.abs(r.x)+Math.abs(r.y))/2});
  }
});

if(rows.length===0) alert("labels にデータがありません");

/* Plotly用描画関数 */
function drawScatter(xField, yField){
  const data = KEYS.map(k => {
    const filtered = rows.filter(r => r.label_true===k && typeof r[xField]==="number" && typeof r[yField]==="number");

    // 重なりを大きさで表現する
    const sizeMap = {};
    filtered.forEach(r=>{
      const key = `${r[xField]}_${r[yField]}`;
      sizeMap[key] = (sizeMap[key]||0) + 1;
    });

    return {
      x: filtered.map(r=>r[xField]),
      y: filtered.map(r=>r[yField]),
      mode: 'markers',
      type: 'scattergl', // 高速＆高解像度
      name: LABEL[k],
      marker: {
        color: COLOR[k],
        size: filtered.map(r=>{
          const key = `${r[xField]}_${r[yField]}`;
          return 5 + sizeMap[key]*2; // 重なりに応じてサイズ大きく
        }),
        opacity:0.7
      }
    };
  });

  const layout = {
    xaxis: { title:xField },
    yaxis: { title:yField },
    legend:{ orientation:"h" },
    margin:{ t:40, l:50, r:20, b:50 },
    hovermode:"closest"
  };

  Plotly.newPlot('scatterPlot', data, layout, {responsive:true});
}

/* 初期表示 */
drawScatter("diff","angleDiff");

/* ボタン切替 */
document.querySelectorAll("button").forEach(btn=>{
  btn.onclick = ()=> drawScatter(btn.dataset.x, btn.dataset.y);
});
</script>

</body>
</html>
