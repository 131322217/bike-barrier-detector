<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>評価グラフ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot/build/Chart.BoxPlot.js"></script>

<style>
body {
  font-family: sans-serif;
  margin: 20px;
}
h2 { margin-top: 40px; }
canvas {
  max-width: 800px;
  margin-bottom: 40px;
}
</style>
</head>
<body>

<h1>段差検出アルゴリズム 評価</h1>

<h2>① 混同行列</h2>
<canvas id="confusionChart"></canvas>

<h2>② diff 分布（正解ラベル別）</h2>
<canvas id="diffChart"></canvas>

<h2>③ z 分布（正解ラベル別）</h2>
<canvas id="zChart"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* ===== Firebase ===== */
const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* ===== label 定義 ===== */
const LABEL_MAP = {
  step: "段差",
  curve: "カーブ",
  none: "平地"
};

const COLOR_MAP = {
  step: "rgba(220, 38, 38, 0.7)",   // 赤
  curve: "rgba(37, 99, 235, 0.7)",  // 青
  none: "rgba(50, 200, 99, 0.6)"  // 緑
};

const KEYS = ["step", "curve", "none"];

/* ===== load data ===== */
const snap = await getDocs(collection(db, "event_labels"));
const data = [];
snap.forEach(d => data.push(d.data()));

/* ===== 混同行列 ===== */
const matrix = {
  step:  {step:0, curve:0, none:0},
  curve: {step:0, curve:0, none:0},
  none:  {step:0, curve:0, none:0}
};

data.forEach(d => {
  if (matrix[d.type_detected] && matrix[d.type_detected][d.type_true] !== undefined) {
    matrix[d.type_detected][d.type_true]++;
  }
});

new Chart(document.getElementById("confusionChart"), {
  type: "bar",
  data: {
    labels: KEYS.map(k => LABEL_MAP[k]),
    datasets: KEYS.map(k => ({
      label: `正解：${LABEL_MAP[k]}`,
      backgroundColor: COLOR_MAP[k],
      data: KEYS.map(x => matrix[x][k])
    }))
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: "top" }
    }
  }
});

/* ===== 分布用 ===== */
function boxDataset(key) {
  return KEYS.map(k => ({
    label: LABEL_MAP[k],
    backgroundColor: COLOR_MAP[k],
    borderColor: COLOR_MAP[k],
    data: data
      .filter(d => d.type_true === k && typeof d[key] === "number")
      .map(d => d[key])
  }));
}

/* ===== diff ===== */
new Chart(document.getElementById("diffChart"), {
  type: "boxplot",
  data: {
    labels: KEYS.map(k => LABEL_MAP[k]),
    datasets: boxDataset("diff")
  },
  options: {
    responsive: true
  }
});

/* ===== z ===== */
new Chart(document.getElementById("zChart"), {
  type: "boxplot",
  data: {
    labels: KEYS.map(k => LABEL_MAP[k]),
    datasets: boxDataset("z")
  },
  options: {
    responsive: true
  }
});
</script>

</body>
</html>
