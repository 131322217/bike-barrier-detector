<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>評価グラフ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot/build/Chart.BoxPlot.js"></script>

<style>
body { font-family: sans-serif; margin: 20px; }
canvas { max-width: 900px; margin-bottom: 40px; }
</style>
</head>
<body>

<h1>段差検出アルゴリズム 評価</h1>

<h2>① 混同行列</h2>
<canvas id="confusionChart"></canvas>

<h2>② diff 分布</h2>
<canvas id="diffChart"></canvas>

<h2>③ z 分布</h2>
<canvas id="zChart"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* ===== Firebase ===== */
const app = initializeApp({
  apiKey: "YOUR_API_KEY",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

/* ===== 定義 ===== */
const KEYS = ["step", "curve", "none"];
const LABEL = { step: "段差", curve: "カーブ", none: "平地" };
const COLOR = {
  step: "rgba(220,38,38,0.7)",
  curve: "rgba(37,99,235,0.7)",
  none: "rgba(34,197,94,0.7)"
};

/* ===== load ===== */
const snap = await getDocs(collection(db, "event_labels"));
const rows = snap.docs.map(d => d.data());

/* ===== 混同行列 ===== */
const matrix = {};
KEYS.forEach(a => {
  matrix[a] = {};
  KEYS.forEach(b => matrix[a][b] = 0);
});

rows.forEach(d => {
  if (matrix[d.type_detected] && matrix[d.type_detected][d.type_true] !== undefined) {
    matrix[d.type_detected][d.type_true]++;
  }
});

new Chart(document.getElementById("confusionChart"), {
  type: "bar",
  data: {
    labels: KEYS.map(k => LABEL[k]),
    datasets: KEYS.map(trueKey => ({
      label: `正解：${LABEL[trueKey]}`,
      backgroundColor: COLOR[trueKey],
      data: KEYS.map(detKey => matrix[detKey][trueKey])
    }))
  }
});

/* ===== 分布 ===== */
function boxData(field) {
  return KEYS.map(k => ({
    label: LABEL[k],
    backgroundColor: COLOR[k],
    borderColor: COLOR[k],
    data: rows
      .filter(d => d.type_true === k && typeof d[field] === "number")
      .map(d => d[field])
  }));
}

new Chart(document.getElementById("diffChart"), {
  type: "boxplot",
  data: { labels: KEYS.map(k => LABEL[k]), datasets: boxData("diff") }
});

new Chart(document.getElementById("zChart"), {
  type: "boxplot",
  data: { labels: KEYS.map(k => LABEL[k]), datasets: boxData("z") }
});
</script>
</body>
</html>
