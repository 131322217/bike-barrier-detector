<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Spatial Filter Map - Real Logic</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  html, body { height:100%; margin:0; font-family: -apple-system, sans-serif; background: #f0f2f5; }
  #map { width:100%; height:100%; }
  .ui-panel {
    position:absolute; top:10px; right:10px; background:white;
    padding:20px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.15);
    z-index:1000; width:300px;
  }
  h3 { margin: 0 0 15px 0; font-size: 16px; color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 8px; }
  .slider-group { background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #1a73e8; }
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
  .stat-box { background: #f8f9fa; padding: 8px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
  .stat-label { font-size: 10px; color: #70757a; display: block; }
  .stat-value { font-size: 16px; font-weight: bold; }
  
  .legend { font-size: 11px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
  .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
  .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
</style>
</head>
<body>

<div id="map"></div>

<div class="ui-panel">
  <h3>ğŸ” ç©ºé–“ãƒ•ã‚£ãƒ«ã‚¿åœ°å›³ (å®ŸåŠ›åˆ¤å®šç‰ˆ)</h3>
  
  <div class="slider-group">
    <label style="font-size:13px; font-weight:bold;">åŠå¾„: <span id="radVal" style="float:right;">4.0</span>m</label>
    <input type="range" id="filterRad" min="0" max="15" step="0.5" value="4.0">
  </div>

  <div class="stat-grid">
    <div class="stat-box" style="grid-column: span 2; border-bottom: 3px solid #1a73e8;">
      <span class="stat-label">F1 SCORE</span>
      <span id="stat_f1" class="stat-value">-</span>
    </div>
    <div class="stat-box">
      <span class="stat-label">èª¤æ¤œå‡º(FP)</span>
      <span id="stat_fp" class="stat-value" style="color:#ff69b4">-</span>
    </div>
    <div class="stat-box">
      <span class="stat-label">è¦‹é€ƒã—(FN)</span>
      <span id="stat_fn" class="stat-value" style="color:#ff8c00">-</span>
    </div>
  </div>

  <div class="legend">
    <div class="legend-item"><span class="dot" style="background:#dc3545"></span>æ­£è§£ (TP)</div>
    <div class="legend-item"><span class="dot" style="background:#ff69b4"></span>èª¤æ¤œå‡º (FP)</div>
    <div class="legend-item"><span class="dot" style="background:#1a73e8"></span>ãƒ•ã‚£ãƒ«ã‚¿é™¤å» (FPå›é¿)</div>
    <div class="legend-item"><span class="dot" style="background:#ff8c00"></span>è¦‹é€ƒã— (FN)</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

// Firebaseè¨­å®š
const app = initializeApp({ apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo", projectId: "bike-barrier-detector-1e128" });
const db = getFirestore(app);

// ãƒãƒƒãƒ—åˆæœŸåŒ–
const map = L.map("map", { zoomControl: false }).setView([35.681, 139.767], 15);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png").addTo(map);
let layerGroup = L.layerGroup().addTo(map);

// ãƒ‡ãƒ¼ã‚¿å¤‰æ•°
let allEvents = [], gtMap = {};
const FIXED_DIFF = 50;
const FIXED_ZRATIO = 0.60;

// åŸºæœ¬åˆ¤å®šï¼ˆAIå˜ä½“ã®äºˆæ¸¬ï¼‰
function getBasePred(f) {
  // ç‰¹å¾´é‡ãŒãªã„å ´åˆã¯åˆ¤å®šä¸å¯(other)
  if (!f || typeof f.diffMax === 'undefined') return "other";
  return (f.diffMax >= FIXED_DIFF && f.zRatio >= FIXED_ZRATIO && !f.zConsistency) ? "step" : "other";
}

// è·é›¢è¨ˆç®— (Haversine formula)
function getDist(e1, e2) {
  const R = 6371000;
  const dLat = (e2.lat - e1.lat) * Math.PI / 180;
  const dLon = (e2.lng - e1.lng) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(e1.lat*Math.PI/180) * Math.cos(e2.lat*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// â˜…æœ€é‡è¦ï¼šæœ€çµ‚åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚°ãƒ©ãƒ•å´ã¨å®Œå…¨çµ±ä¸€ï¼‰
function getFinalPred(target, rad, pool) {
  const base = getBasePred(target.features);
  
  // åŠå¾„0ã¾ãŸã¯å…ƒã€…otherãªã‚‰ä½•ã‚‚ã—ãªã„
  if (rad <= 0 || base === "other") return base;
  
  // è¿‘æ‰€ã‚’æ¢ã™ï¼ˆè‡ªåˆ†ä»¥å¤–ã€ã‹ã¤åŠå¾„å†…ã€ã‹ã¤æœ‰åŠ¹ãªç‰¹å¾´é‡ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰
  const neighbors = pool.filter(n => 
    n.id !== target.id && 
    getDist(target, n) <= rad &&
    n.features && typeof n.features.diffMax !== 'undefined'
  );

  if (neighbors.length > 0) {
    // ã€ä¿®æ­£æ¸ˆã¿ã€‘æ­£è§£(gt)ã§ã¯ãªãã€äºˆæ¸¬(getBasePred)ã‚’è¦‹ã¦å¤šæ•°æ±ºã‚’ã¨ã‚‹
    // ã“ã‚Œã«ã‚ˆã‚Šã€èª¤æ¤œå‡ºã®é›†å›£ã«é‡£ã‚‰ã‚Œã‚‹ç¾è±¡ã‚‚æ­£ã—ãã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã•ã‚Œã‚‹
    const stepCount = neighbors.filter(n => getBasePred(n.features) === "step").length;
    
    // æ”¯æŒç‡ãŒ50%ä»¥ä¸‹ãªã‚‰å´ä¸‹
    if (stepCount / neighbors.length <= 0.5) return "other";
  }
  
  // ä»²é–“ãŒã„ãªã„(0äºº)ã®å ´åˆã¯ã€è‡ªåˆ†ã®æ„è¦‹ã‚’é€šã™
  return "step";
}

// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function load() {
  const [eSnap, lSnap] = await Promise.all([
    getDocs(collection(db, "raw_events")),
    getDocs(collection(db, "event_labels"))
  ]);
  
  // æ­£è§£ãƒ©ãƒ™ãƒ«ã®ãƒãƒƒãƒ”ãƒ³ã‚°
  lSnap.forEach(d => { gtMap[d.data().eventId] = d.data().groundTruth; });
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®çµåˆ
  allEvents = eSnap.docs.map(d => ({
    id: d.id,
    ...d.data(),
    gt: gtMap[d.id] || "other"
  }));
  
  // ãƒãƒƒãƒ—ã®è¡¨ç¤ºç¯„å›²ã‚’èª¿æ•´
  if (allEvents.length > 0) {
    const group = new L.featureGroup(allEvents.map(e => L.marker([e.lat, e.lng])));
    map.fitBounds(group.getBounds(), { padding: [50, 50] });
  }
  
  render();
}

// æç”» & é›†è¨ˆ
function render() {
  layerGroup.clearLayers();
  
  const rad = parseFloat(document.getElementById("filterRad").value);
  document.getElementById("radVal").textContent = rad.toFixed(1);
  
  let tp=0, fp=0, fn=0;

  allEvents.forEach(ev => {
    // ãƒ‡ãƒ¼ã‚¿æ¬ æï¼ˆfeaturesãªã—ï¼‰ã¯é›†è¨ˆã‹ã‚‰ã‚‚åœ°å›³ã‹ã‚‰ã‚‚é™¤å¤–
    if (!ev.features || typeof ev.features.diffMax === 'undefined') return;

    const base = getBasePred(ev.features);
    const pred = getFinalPred(ev, rad, allEvents);
    const truth = ev.gt === "step" ? "step" : "other";
    
    let color = "#bbb", opacity = 0.3, radius = 4;
    let isImportant = false;

    if (pred === "step" && truth === "step") {
      // æ­£è§£ (TP)
      color = "#dc3545"; opacity = 0.8; radius = 6; tp++;
      isImportant = true;
    } 
    else if (pred === "step" && truth !== "step") {
      // èª¤æ¤œå‡º (FP)
      color = "#ff69b4"; opacity = 0.8; radius = 6; fp++;
      isImportant = true;
    }
    else if (base === "step" && pred === "other" && truth !== "step") {
      // ãƒ•ã‚£ãƒ«ã‚¿æˆåŠŸ (é’è‰²): å…ƒã€…èª¤æ¤œå‡ºã ã£ãŸãŒã€ãƒ•ã‚£ãƒ«ã‚¿ã§æ•‘ã£ãŸ
      color = "#1a73e8"; opacity = 0.6; radius = 5;
      isImportant = true;
    }
    else if (truth === "step" && pred !== "step") {
      // è¦‹é€ƒã— (FN): å…ƒã€…è¦‹é€ƒã—ã€ã¾ãŸã¯ãƒ•ã‚£ãƒ«ã‚¿ã§æ¶ˆã—ã¦ã—ã¾ã£ãŸ
      color = "#ff8c00"; opacity = 0.8; radius = 6; fn++;
      isImportant = true;
    }

    // åœ°å›³ã«è¦‹ã›ã‚‹ã®ã¯ã€Œé‡è¦ãªç‚¹ï¼ˆTP/FP/FN/æ•‘æ¸ˆï¼‰ã€ã®ã¿
    if (isImportant) {
      L.circleMarker([ev.lat, ev.lng], {
        radius: radius,
        color: "white",
        weight: 1,
        fillColor: color,
        fillOpacity: opacity
      }).addTo(layerGroup);
    }
  });

  // ã‚¹ã‚³ã‚¢è¨ˆç®—
  const p = tp / (tp + fp || 1);
  const r = tp / (tp + fn || 1);
  const f1 = (2 * p * r) / (p + r || 1);

  document.getElementById("stat_f1").textContent = f1.toFixed(3);
  document.getElementById("stat_fp").textContent = fp;
  document.getElementById("stat_fn").textContent = fn;
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.getElementById("filterRad").oninput = render;

// é–‹å§‹
load();
</script>
</body>
</html>