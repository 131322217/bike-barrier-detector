<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>精度評価・比較マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  html, body { height:100%; margin:0; font-family: sans-serif; }
  #map { width:100%; height:100%; }
  .panel {
    position:absolute; top:10px; left:10px; background:white;
    padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.2);
    z-index:1000; width:280px; font-size:13px; max-height: 90vh; overflow-y: auto;
  }
  .stat-card { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #007bff; }
  .slider-group { margin: 10px 0; }
  input[type=range] { width: 100%; }
  .legend-item { display: flex; align-items: center; margin-bottom: 3px; }
  .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
</style>
</head>
<body>
<div id="map"></div>
<div class="panel">
  <h3>実験評価・比較設定</h3>
  
  <div class="stat-card">
    <b>現在の精度統計</b><br>
    正答率: <span id="stat_acc">-</span><br>
    F1スコア: <span id="stat_f1">-</span><br>
    誤検出(FP): <span id="stat_fp">-</span> / 見逃し(FN): <span id="stat_fn">-</span>
  </div>

  <div class="slider-group">
    <label>分類アルゴリズム</label>
    <select id="formula" style="width:100%">
      <option value="old">旧式（段階評価）</option>
      <option value="new">新式（厳格判定）</option>
    </select>
  </div>

  <div class="slider-group">
    <label>diffMax閾値: <span id="diffVal">45</span></label>
    <input type="range" id="diffTh" min="30" max="70" step="5" value="45">
  </div>

  <div class="slider-group">
    <label>zRatio閾値: <span id="zVal">0.60</span></label>
    <input type="range" id="zTh" min="0.3" max="0.9" step="0.05" value="0.6">
  </div>

  <hr>
  <h4>判定結果の凡例</h4>
  <div class="legend-item"><span class="dot" style="background:#28a745"></span>一致 (正解 / TP)</div>
  <div class="legend-item"><span class="dot" style="background:#dc3545"></span>誤検出 (判定ミス / FP)</div>
  <div class="legend-item"><span class="dot" style="background:#007bff"></span>見逃し (未検出 / FN)</div>
  <div class="legend-item"><span class="dot" style="background:#ccc"></span>その他（一致）</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyAb9Zt2Hw_o-wXfXby6vlBDdcWZ6xZUJpo",
  projectId: "bike-barrier-detector-1e128"
});
const db = getFirestore(app);

const map = L.map("map").setView([35.681, 139.767], 15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let allEvents = [];
let gtMap = {};
let markers = [];

// 分類ロジック (experiment.htmlから移植)
function classify(f, formula, diffTh, zTh) {
  const d = f.diffMax || 0;
  const zr = f.zRatio || 0;
  const zc = !!f.zConsistency;
  const xy = f.xyRatio || 0;

  if (formula === "old") {
    if (d >= diffTh && zr >= zTh && !zc) return "step";
  } else {
    if (d >= diffTh + 5 && zr >= zTh + 0.05 && !zc && xy < 0.45) return "step";
  }
  return "other";
}

async function loadData() {
  const [eSnap, lSnap] = await Promise.all([
    getDocs(collection(db, "raw_events")),
    getDocs(collection(db, "event_labels"))
  ]);
  allEvents = eSnap.docs.map(d => ({ id: d.id, ...d.data() }));
  lSnap.forEach(d => { gtMap[d.data().eventId] = d.data().groundTruth; });
  render();
}

function render() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const formula = document.getElementById("formula").value;
  const diffTh = Number(document.getElementById("diffTh").value);
  const zTh = Number(document.getElementById("zTh").value);

  let tp=0, fp=0, fn=0, tn=0;

  allEvents.forEach(ev => {
    const truth = gtMap[ev.id] === "step" ? "step" : "other";
    const pred = classify(ev.features, formula, diffTh, zTh);

    let color = "#ccc"; // その他一致
    if (pred === "step" && truth === "step") { color = "#28a745"; tp++; } // TP
    else if (pred === "step" && truth !== "step") { color = "#dc3545"; fp++; } // FP
    else if (pred !== "step" && truth === "step") { color = "#007bff"; fn++; } // FN
    else { tn++; }

    if (truth === "step" || pred === "step") {
      const m = L.circleMarker([ev.lat, ev.lng], {
        radius: 8, color: color, fillColor: color, fillOpacity: 0.7
      }).addTo(map);
      
      m.bindPopup(`
        <b>判定: ${pred}</b> (正解: ${truth})<br>
        diffMax: ${ev.features.diffMax.toFixed(1)}<br>
        zRatio: ${ev.features.zRatio.toFixed(2)}
      `);
      markers.push(m);
    }
  });

  // 統計更新
  const acc = (tp + tn) / allEvents.length;
  const prec = tp / (tp + fp || 1);
  const rec = tp / (tp + fn || 1);
  const f1 = (2 * prec * rec) / (prec + rec || 1);

  document.getElementById("stat_acc").textContent = acc.toFixed(3);
  document.getElementById("stat_f1").textContent = f1.toFixed(3);
  document.getElementById("stat_fp").textContent = fp;
  document.getElementById("stat_fn").textContent = fn;
}

// イベント設定
document.getElementById("formula").onchange = render;
document.getElementById("diffTh").oninput = (e) => {
  document.getElementById("diffVal").textContent = e.target.value;
  render();
};
document.getElementById("zTh").oninput = (e) => {
  document.getElementById("zVal").textContent = Number(e.target.value).toFixed(2);
  render();
};

loadData();
</script>
</body>
</html>